<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, user-scalable=no">
  </head>
  <body>
    <link href="//vjs.zencdn.net/7.3.0/video-js.min.css" rel="stylesheet">
    <!-- <link href="https://unpkg.com/video.js@6.11.0/dist/video-js.min.css" rel="stylesheet"> -->
    <link href="/lib/videojs-resolution-switcher.css" rel="stylesheet" type="text/css">
    <!-- <link href="https://cdn.jsdelivr.net/npm/videojs-resolution-switcher-v6@0.6.0/lib/videojs-resolution-switcher.css" rel="stylesheet"> -->
    <style>
      iframe {
        width: 100%;
        height: 90%;
      }
    </style>
    <input placeholder="Page number" id="pageNum" type="number"/>
    <input placeholder="Video number" id="videoNum" type="number"/>
    <button onclick="clickStart()">
      자동 재생 시작
    </button>
    <div id="isStarted">
      시작 버튼을 누르세요
    </div>

    <video id="player" class="video-js vjs-default-skin" width="700" controls data-setup='{}' muted>
      <source src="https://vjs.zencdn.net/v/oceans.mp4?480" type='video/mp4' label='SD' res='480' />
      <source src="https://vjs.zencdn.net/v/oceans.mp4?1080" type='video/mp4' label='HD' res='1080'/>
      <source src="https://vjs.zencdn.net/v/oceans.mp4?144" type='video/mp4' label='phone' res='144'/>
      <source src="https://vjs.zencdn.net/v/oceans.mp4?2160" type='video/mp4' label='4k' res='2160'/>
    </video>
    <script type='text/javascript' src="//vjs.zencdn.net/7.3.0/video.min.js"></script>
    <!-- <script src="https://unpkg.com/video.js@6.11.0/dist/video.min.js"></script> -->
    <script type='text/javascript' src="/lib/videojs-resolution-switcher.js"></script>
    <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/videojs-resolution-switcher-v6@0.6.0/lib/videojs-resolution-switcher.min.js"></script> -->

   <script>
     videojs('player').videoJsResolutionSwitcher()
   </script>

    <script>
      var VIDEO_TIMEOUT = 240000;
      var MAX_VIDEO_OFFSET = 25;
      var MAX_PAGE_OFFSET = 24;

      var pageOffSet = 1,
          videoOffset = 1;
      
      var timer = null;
      function clickStart() {
        if (timer) {
          clearTimeout(timer);
          timer = null;
        }

        send();
      }
          
      function send() {
        var httpRequest = new XMLHttpRequest();

        function reqListener () {
          console.log('httpRequest', httpRequest)
          if (httpRequest.readyState == 4) {
            if (httpRequest.status == 200) {
              var videoLink = httpRequest.responseText;
              document.getElementById("isStarted").innerText = "재생 중...";
              document.getElementById("iframeVideo").src = videoLink;
              timer = setTimeout(() => {
                videoOffset += 1;
                if (videoOffset > MAX_VIDEO_OFFSET) {
                  pageOffSet += 1;
                  videoOffset = 1;
                }

                if (pageOffSet === MAX_PAGE_OFFSET) {
                  pageOffSet = 1;
                  videoOffset = 1;
                }
                getUrl();
              }, VIDEO_TIMEOUT);
            } else { 
              alert("실패: " + httpRequest.status);
            }
          }
        }

        function getUrl() {
          var pageInputVal = document.getElementById("pageNum").value,
              videoInputVal = document.getElementById("videoNum").value;
      
          if (pageInputVal) {
            pageOffSet = pageInputVal;
          }
          if (videoInputVal) {
            videoOffset = videoInputVal;
          }

          document.getElementById("isStarted").innerText = "동영상 가져오는 중...";

          console.log('Get video url');
          console.log('Page offset', pageOffSet);
          console.log('Video offset', videoOffset);

          httpRequest.onreadystatechange = reqListener;
          httpRequest.open("GET", "/api/autoplay?" + "page=" + pageOffSet + "&video=" + videoOffset);
          httpRequest.send();
        }

        getUrl();
      }
    </script>
  </body>
</html>